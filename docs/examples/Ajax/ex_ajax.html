<!DOCTYPE html>
<html>
<head lang="en">
    <title></title>
    <script src="../../../src/KUBE.js"></script>

    <script type="text/javascript">
        var uses = {
            'Client':'/Library/Ajax/Client',
            'Response':'/Library/Ajax/Response',
            'XM':'/Library/Extend/Math'
        };

        KUBE.Uses(uses,function($K){
            //startFunctionServerTest($K);
            startRemoteServerTest($K);
        });

        function startRemoteServerTest($K){
            var Client = $K.Client();
            //Can also create a request by using /Library/Ajax/Request and getting it that way
            //but Client also contains a Request factory.
            var Request = Client.CreateRequest();

            //Set up our Client and a dummy Request
            Client.SetTarget('http://localhost:10999');
            Request.AddHeader('X-Test','Test');
            Request.AddData('key','val');

            testRemoteRequest(Client,Request);
        }

        function testRemoteRequest(Client,Request){
            //Use a Client that has already been set up to send a Request Object
            var TestRequest = Client.SendRequest(Request);
            TestRequest.Then(function(_resolve,_reject,_Response){
                console.log(_Response.GetData());
            });
            TestRequest.Catch(function(_resolve,_reject,_err){
                console.log(_err.msg);
            });

//            //Throw it again because madness
//            setTimeout(function(){
//                testRequest(Client,Request);
//            },Math.KUBE().random(100,5000));
        }


        function startFunctionServerTest($K){
            //Assign them (both are factories)
            var Client = $K.Client();
            var Request = Client.CreateRequest();

            //Set up our Client and a dummy Request
            Client.SetTarget(chaosServer);
            Request.AddHeader('X-Test','Test');
            Request.AddData('key','val');

            testFunctionRequest(Client,Request);
        }

        function testFunctionRequest(Client,Request){
            //Use a Client that has already been set up to send a Request Object
            var TestRequest = Client.SendRequest(Request);
            TestRequest.Then(function(_resolve,_reject,_Response){
                console.log(_Response.GetData());
            });
            TestRequest.Catch(function(_resolve,_reject,_err){
                console.log(_err.msg);
            });

            //Throw it again because madness
//            setTimeout(function(){
//                testRequest(Client,Request);
//            },Math.KUBE().random(100,5000));
        }

        function chaosServer(_Request){
            if(KUBE.Is(_Request,true) === 'Request'){
                var chaosFuncs = [nothing,successfulResponse,rejectedRequest];
                return chaosFuncs[Math.KUBE().random(0,2)](_Request);
            }
        }

        function nothing(_Request){
            console.log(getId()+': Chaos server returning false');
            return false;
        }

        function successfulResponse(_Request){
            //Return a promise, wait a random amount of time to return the Response
            return KUBE.Promise(function(_resolve){
                var msgId = getId();
                console.log(msgId+': Chaos server returning valid response');
                setTimeout(function(){
                    var Response = KUBE.Class('/Library/Ajax/Response')();
                    Response.SetData(msgId+': Successful response!');
                    _resolve(Response);
                },Math.KUBE().random(250,5000));
            });
        }

        function rejectedRequest(_Request){
            //Return a promise, wait a random amount of time to Reject
            return KUBE.Promise(function(_resolve,_reject){
                var msgId = getId();
                console.log(msgId+': Chaos server rejecting the request: because... monkeys');
                setTimeout(function(){
                    _reject({'msg':msgId+': monkeys','data':'large monkeys'});
                },Math.KUBE().random(250,5000));
            });
        }

        var id = 0;
        function getId(){
            return id++;
        }
    </script>
</head>
<body>

</body>
</html>